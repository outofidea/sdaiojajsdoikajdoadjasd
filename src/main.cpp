//                                          $$\     $$\                             $$\                                     $$\                                                               $$\       $$\                               
//                                          $$ |    $$ |                            $$ |                                    $$ |                                                              $$ |      $$ |                              
//$$$$$$\$$$$\   $$$$$$\  $$\   $$\       $$$$$$\   $$$$$$$\   $$$$$$\         $$$$$$$ | $$$$$$\   $$$$$$\   $$$$$$\        $$$$$$$\   $$$$$$\   $$$$$$\  $$$$$$$\  $$\   $$\  $$$$$$\        $$$$$$$\  $$ | $$$$$$\   $$$$$$$\  $$$$$$$\ 
//$$  _$$  _$$\  \____$$\ $$ |  $$ |      \_$$  _|  $$  __$$\ $$  __$$\       $$  __$$ |$$  __$$\ $$  __$$\ $$  __$$\       $$  __$$\ $$  __$$\ $$  __$$\ $$  __$$\ $$ |  $$ | \____$$\       $$  __$$\ $$ |$$  __$$\ $$  _____|$$  _____|
//$$ / $$ / $$ | $$$$$$$ |$$ |  $$ |        $$ |    $$ |  $$ |$$$$$$$$ |      $$ /  $$ |$$$$$$$$ |$$ |  \__|$$ /  $$ |      $$ |  $$ |$$ |  \__|$$ /  $$ |$$ |  $$ |$$ |  $$ | $$$$$$$ |      $$ |  $$ |$$ |$$$$$$$$ |\$$$$$$\  \$$$$$$\  
//$$ | $$ | $$ |$$  __$$ |$$ |  $$ |        $$ |$$\ $$ |  $$ |$$   ____|      $$ |  $$ |$$   ____|$$ |      $$ |  $$ |      $$ |  $$ |$$ |      $$ |  $$ |$$ |  $$ |$$ |  $$ |$$  __$$ |      $$ |  $$ |$$ |$$   ____| \____$$\  \____$$\ 
//$$ | $$ | $$ |\$$$$$$$ |\$$$$$$$ |        \$$$$  |$$ |  $$ |\$$$$$$$\       \$$$$$$$ |\$$$$$$$\ $$ |      $$$$$$$  |      $$$$$$$  |$$ |      \$$$$$$  |$$ |  $$ |\$$$$$$$ |\$$$$$$$ |      $$$$$$$  |$$ |\$$$$$$$\ $$$$$$$  |$$$$$$$  |
//\__| \__| \__| \_______| \____$$ |         \____/ \__|  \__| \_______|       \_______| \_______|\__|      $$  ____/       \_______/ \__|       \______/ \__|  \__| \____$$ | \_______|      \_______/ \__| \_______|\_______/ \_______/ 
//                        $$\   $$ |                                                                        $$ |                                                    $$\   $$ |                                                            
//                        \$$$$$$  |                                                                        $$ |                                                    \$$$$$$  |                                                            
//                         \______/                                                                         \__|                                                     \______/                                                             
//  $$\     $$\       $$\                                           $$\                                                                                                                                                                   
//  $$ |    $$ |      \__|                                          $$ |                                                                                                                                                                  
//$$$$$$\   $$$$$$$\  $$\  $$$$$$$\        $$$$$$$\  $$$$$$\   $$$$$$$ | $$$$$$\                                                                                                                                                          
//\_$$  _|  $$  __$$\ $$ |$$  _____|      $$  _____|$$  __$$\ $$  __$$ |$$  __$$\                                                                                                                                                         
//  $$ |    $$ |  $$ |$$ |\$$$$$$\        $$ /      $$ /  $$ |$$ /  $$ |$$$$$$$$ |                                                                                                                                                        
//  $$ |$$\ $$ |  $$ |$$ | \____$$\       $$ |      $$ |  $$ |$$ |  $$ |$$   ____|                                                                                                                                                        
//  \$$$$  |$$ |  $$ |$$ |$$$$$$$  |      \$$$$$$$\ \$$$$$$  |\$$$$$$$ |\$$$$$$$\                                                                                                                                                         
//   \____/ \__|  \__|\__|\_______/        \_______| \______/  \_______| \_______|                                                                                                                                                        
//                                                                   
//                                                                            @@@@@#:%@@@@                                         
//                                                                 :@@@@@@@@   @@@@  @ @   @@                                      
//                                                      @@@@@@@@.-:          : =@@@@= @@@ @@ @@                                    
//                                                 @@@@                               @@@  @   @                                   
//                                             @@@                                        @@@   @                                  
//                                         @@@                                               @@@ @@@@@@@                           
//                                      *@@                                                     @@@  ::%@@@@                       
//                                    @@                                                           @@*-=*=@@                       
//                                  @@                                                        ...    @@%+@@                        
//                                @@                                                              :    @@.=@@                      
//                              @@              .. .                            . . . . .           .    @=.*@@                    
//                            @@                        +                    @              .:=      .    @@ =%@                   
//                           @@   .                    @                     @                 :=     :    @@.+%@                  
//                          @                          @                     @                   -    .     @@-+%@                 
//                         @                           @                     @                    :===:.     @@+*%@                
//                        @                            @                     @                     .   .      @=+%@                
//                       @@                 @@@@@@@    @                    @@                      :  .       @%@                 
//                       @                           @@@                    @@ @@@@@@@               .         @@                  
//                      @@          *              @@  @@                  @@@@        =@@@                    @@                  
//                      @          @             @@     @                  @   @           @@                   @                  
//                      @          @       @@@@@@@@@    @                 @     @@@@@*                          @                  
//                      @         @   @@@@           @@  @               @  @@@        @@                       @                  
//                     @@        @@   @@     @@@      @@ @@             @  @             *@ @@  @              @@                  
//                     @@        @@@. @    @@@%@@@     -@ @@      @   =@ @@      @@@@@     @    @              @@                  
//                    @ @        @    @    @%%%%@@      @   @    @   @@ *@      @@%%%@@     @   @@             @ @                 
//                   @@ @        @@   @    @@@@@@       @    @@  @  @   @       @@%%%@@     @@  @@            @@ @@                
//                  @@@@ @       @@   @                 @      @@ @@    @        @@@@@      @@@@@             @@. @@               
//                       @        @   @@               @@      @@@@@@   @@                  @   @            @    @@@              
//                        @       @@   +@             @                  @                  @  @@           @@                     
//                         @@ @    @@    @@@       @@@                    @               @@   @           @@                      
//                           @@@@@  @@ .     @@@@@                         @@           @@    @@          @@                       
//                            @   %@                                          @@@@@@@@@@     @@          @ @                       
//                            @  @@    :.  ...:                                             @@     @   @@  @                       
//                           @@  @                         @                               @.     @@  @    @@                      
//                          =@   @                          @@%     @@                   @@    @@ @ @@  ::  @@                     
//                         @@  : @                              @@@                    @@@@@@@   @@@   ::::   @                    
//                        @   :: @@                                                              @@  .::....   @@                  
//                      @@  ..::   @                                                           .@   :.........  @@@                
//                    @@@  . ...:.  @@                                                       @@   .... ..... ..  @@@#              
//                  @@ @     . .. .   @@@                                                 @@@    ......    ..     @ @@             
//                 @* @@ .      .  ..    *@@                                           @@@    . ..      ..      . @   @            
//                @@   @  .     .    .       @@@                                   @@@@                       .   @   *@           
//                @    @=  .        .   @  @@@   @@@@.                       %@@@@     @@                        @@    @           
//                @@    @@     . . .    @@ @       @=%@@@@@@@@@@@@@@@@@@@@@@@#=:@@@       @@@       .    . .   @@     @            
//                 @#     @@         @ @@@@@@@    @@@@@@@@@@@@%@   :@@@%*+@@@@@@% @       @ @@@    .....     @@      @@            
//                  @@      :@@=  @@@  @ @        @@           @@@ @@   @@@     @@ @      @ @@ @@        @@@       @@@             
//                  @ @@        @   @    @       @@              @@ @@@          @@@    @@@ @    @@@@@@#         @@  @             
//                  @ @@@@@@   @@    @@@        @@         @@@@:.@@               @ @@@@ @ @@    @*  @@  @@@@@@@@    @             
//                  @@       @@     @ @      @@ @@@@@@@@@@  @@               @@@@@@@@ @@@@ @@     @@ @@@@=.....:@  @@              
//                  @        @      @ @   @@@  @           @           @             @   @@@      @@@@ @.=+++++-=@@                
//                 @@       @   @ @@    @@    @   . :        @@@    @@@              @@     @@ @@@@=%@ @-++++++=+@@@@@             
//                  @@      % @      @@       @                  @@     :            @@       @@   @@ @#=++*+=:+@                  
//                   @@@    @     +@@         @  -          :                  :     @@@         @@  @%=+*=*@@@@                   
//                       @@      @@          @@                                     @*.@           @@*:+++:@                       
//                       @@    @@            @ %@@                                @@%@ @@           @@@#..=@                       
//                         @@@@             @@.=# -*-@@@     @@@@@@@@@*    #@@@@@@@@  =:@              @@@@                        
//                                          @=:+% : @= -%@@@@#=::::..=@@@@@-        :%*:@                                          
//                                          @==+*%   #*+-.-:@:+=-:.=@@     @@##@@@ @**+-=@                                         
//                                         @@--=+*@:. #+=:@-@=%@@@@@ ++%+  @+=@    @:++=.@                                         
//                                         @@#%==+#.:%*+-@:-*%   ..:=*+*#@ @+=*@%: @%@#=.@@                                        
//                                         @  %+==**#*+==-@@  @##+*+++++*@ %+++*%@*@  @==%@                                        
//                                        @@= @#%+=+-**#=@.=#%%=@ +++*+**: %++**=@@@  @+  @                                        
//                                        @::+* +*=#%@ #:@:+**+===*+==++*##**+++=@  @@:@%-@                                        
//                                        @@:+#@ %@@   @:@:++*+*+*+=@+*++++++++=@.+= #@:+:@:                                       
//                                        @       @    @ -                       . @  =:: @@                                       
//
//
//
#include <Arduino.h>
#include <ucode.h>
#include <CircularBuffer.hpp>

// #define PROTOTYPE

#define ENABLE_PRINT

#define SERVO_LT 6
#define SERVO_LB 9
#define SERVO_RT 14
#define SERVO_RB 16

#define SERVO_CLAW 3

#define LRSMALLBIAS 1000
#define LRLARGEBIAS 500

#define CLOCKWISE 0
#define COUNTERCLOCKWISE 1

#define MAXTURNRPM 90
#define NORMALTURNRPM 70
#define MAXSTRAIGHTRPM 70
#define NORMALSTRAIGHTRPM 10

#define WHEEL_DIAMETER_cm 6
#define ONE_REVOLUTION_DISTANCE WHEEL_DIAMETER_cm *PI
#define ONE_RPM_IN_UCODE 4

#define IGNORE_TIME_MILLIS 1000

// float Setpoint = 3500;
double Kp = 10.0;
double Ki = 0;
double Kd = 4.0;

enum INSTRUCTIONS
{
  LEFT,
  RIGHT,
  SKIP,
  RET,
  OPN,
  CLS
};

// INSTRUCTIONS inst_queue[] = {RIGHT, LEFT, SKIP, REV, SKIP, RIGHT};

static INSTRUCTIONS inst_queue[] = {RIGHT, SKIP, SKIP, SKIP, SKIP, LEFT};

INSTRUCTIONS current_inst = inst_queue[0];

int turntime = 1300;

bool plotEnable = false;

bool ignore_out_sens = false;

bool returning_from_obj = false;

bool start_return = false;

bool is_double_branch = false;

bool reverse = false;

int lasterror = 0;
int P, I, D = 0;

uint8_t max_inst_index = sizeof(inst_queue) / sizeof(INSTRUCTIONS);

uint8_t curr_inst_index = 0;

uint16_t ignore_out_sens_counter = 0;

uint16_t ignore_double_branch_counter = 0;

int right_count = 0;
int left_count = 0;
int obj_count = 0;

void FWD(int spd)
{
  setServoTurn(SERVO_LT, COUNTERCLOCKWISE, spd);
  setServoTurn(SERVO_LB, COUNTERCLOCKWISE, spd);
  setServoTurn(SERVO_RT, CLOCKWISE, spd);
  setServoTurn(SERVO_RB, CLOCKWISE, spd);
}

void BWD(int spd)
{
  setServoTurn(SERVO_LT, CLOCKWISE, spd);
  setServoTurn(SERVO_LB, CLOCKWISE, spd);
  setServoTurn(SERVO_RT, COUNTERCLOCKWISE, spd);
  setServoTurn(SERVO_RB, COUNTERCLOCKWISE, spd);
}

void LFT(int spd)
{
  setServoTurn(SERVO_LT, CLOCKWISE, spd);
  setServoTurn(SERVO_LB, CLOCKWISE, spd);
  setServoTurn(SERVO_RT, CLOCKWISE, spd);
  setServoTurn(SERVO_RB, CLOCKWISE, spd);
}

void RGT(int spd)
{
  setServoTurn(SERVO_LT, COUNTERCLOCKWISE, spd);
  setServoTurn(SERVO_LB, COUNTERCLOCKWISE, spd);
  setServoTurn(SERVO_RT, COUNTERCLOCKWISE, spd);
  setServoTurn(SERVO_RB, COUNTERCLOCKWISE, spd);
}

void STP()
{
  setServoStop(SERVO_LT);
  setServoStop(SERVO_LB);
  setServoStop(SERVO_RT);
  setServoStop(SERVO_RB);
}

void inc_inst()
{
  Serial.println("index inc");
  Serial.print("max: ");
  Serial.println(max_inst_index);
  curr_inst_index == max_inst_index - 1 ? curr_inst_index = curr_inst_index : curr_inst_index++;
  current_inst = inst_queue[curr_inst_index];
  Serial.print("curr index:");
  Serial.println(curr_inst_index);
}

void setup()
{
  // put your setup code here, to run once:
  Serial.println("adasda");
  Initialization_Pruned();
  // Initialization();
  if (protocolRunState == false)
  {
    setEyelightAllPetals(1, 255, 51, 204);
  }
}

void loop()
{
  if (protocolRunState == false)
  {
    // LINE SENSOR VALUE, 1 MEANS ON LINE, 0 MEANS OFF LINE

    //  middle
    int linesens3 = readGrayValue(3, 0);
    // small lr
    int linesens2 = readGrayValue(2, 0);
    int linesens4 = readGrayValue(4, 0);
    // big lr
    int linesens1 = readGrayValue(1, 0);
    int linesens5 = readGrayValue(5, 0);

    int error = linesens4 * LRSMALLBIAS - linesens2 * LRSMALLBIAS;

    if (linesens1 | linesens5)
    {
      // stabilize sensor readin
      STP();

      delay(250);

      linesens1 = readGrayValue(1, 0);
      linesens5 = readGrayValue(5, 0);

      setEyelightAllPetals(1, 108, 15, 247);

      // Serial.println("huh");

      Serial.print("current instruction:");
      switch (current_inst)
      {
      case LEFT:
        Serial.println("left");
        if (linesens5 && !ignore_out_sens)
        {
          setEyelightAllPetals(1, 255, 0, 0);
          FWD(130);
          delay(300);
          LFT(100);
          delay(turntime);
          STP();
          ignore_out_sens = true;
          ignore_out_sens_counter = millis();
          inc_inst();
          Serial.println("lft");
        }
        break;

      case RIGHT:
        Serial.println("right");
        if (linesens1 && !ignore_out_sens)
        {
          setEyelightAllPetals(1, 0, 255, 0);
          FWD(130);
          delay(300);
          RGT(100);
          delay(turntime);
          STP();
          ignore_out_sens = true;
          ignore_out_sens_counter = millis();
          inc_inst();
          Serial.println("rgt");
        }
        break;

      case RET:
        Serial.println("ret");
        break;

      case SKIP:
        Serial.println("skip");
        FWD(100);
        delay(200);
        STP();
        inc_inst();
        break;

      case OPN:
        Serial.println("open");
        break;

      case CLS:
        Serial.println("close");
        break;

      default:
        break;
      }

      if (linesens1 && linesens5 && !returning_from_obj)
      {
        // objective box or branch
        STP();
        Serial.println(linesens1);
        Serial.println(linesens5);
        delay(100);
        // returning_from_obj = true;
        // start_return = true;
        setEyelightAllPetals(1, 247, 15, 15);
        // Serial.println("bruh");
      }
    }
    else if (returning_from_obj | (start_return && linesens1 && linesens5))
    {
      BWD(200);
      delay(100);
      STP();

      reverse = true;

      while (true)
      {
        if (reverse)
        {
          setRgbledColor(245, 66, 96);
        }
        linesens1 = readGrayValue(1, 0);
        linesens5 = readGrayValue(5, 0);
        setEyelightAllPetals(1, 233, 245, 66);
        if (linesens1 && linesens5)
        {
          STP();
          start_return = false;
          reverse = false;
          Serial.println("end reverse");
          break;
        }
        Serial.println("reversing..");
        BWD(MAXSTRAIGHTRPM);
      }
    }
    else
    {
      // Serial.println("pid");
      ignore_out_sens ? setEyelightAllPetals(1, 255, 102, 102) : setEyelightAllPetals(1, 0, 255, 204);

      if (ignore_out_sens && (millis() - ignore_out_sens_counter >= IGNORE_TIME_MILLIS))
      {
        ignore_out_sens = false;
      }

      P = error;

      I = I + error;

      D = error - lasterror;

      lasterror = error;

      int result = reverse ? -(P * Kp + I * Ki + D * Kd) : P * Kp + I * Ki + D * Kd;

      if (result > 0) // to right
      {
        LFT(constrain(result + NORMALTURNRPM, NORMALTURNRPM, MAXTURNRPM));
      }
      if (result < 0)
      {
        RGT(constrain(result + NORMALTURNRPM, NORMALTURNRPM, MAXTURNRPM));
      }
      if (result == 0)
      {
        reverse ? BWD(MAXSTRAIGHTRPM) : FWD(MAXSTRAIGHTRPM);
      }
    }
    if (current_inst == OPN)
    {
      setServoAngle(SERVO_CLAW, 90, 10);
    }
    if (current_inst == CLS)
    {
      setServoAngle(SERVO_CLAW, -70, 10);
    }

#ifdef ENABLE_PRINT
    if (plotEnable)
    {
      Serial.print(">P:");
      Serial.println(P);
      Serial.print(">I:");
      Serial.println(I);
      Serial.print(">D:");
      Serial.println(D);
      Serial.print(">error:");
      Serial.println(error);
    }

    if (Serial.available())
    {
      STP();
      String incoming = Serial.readString();
      incoming.trim();
      char first = incoming.charAt(0);
      switch (first)
      {
      case 'p':
        Kp = incoming.substring(1).toFloat();
        Serial.print("Kp set to: ");
        Serial.println(Kp);
        break;
      case 'i':
        Ki = incoming.substring(1).toFloat();
        Serial.print("Ki set to: ");
        Serial.println(Ki);
        break;
      case 'd':
        Kd = incoming.substring(1).toFloat();
        Serial.print("Kd set to: ");
        Serial.println(Kd);
        break;
      case 'q':
        Serial.print("Kp set to: ");
        Serial.println(Kp);
        Serial.print("Ki set to: ");
        Serial.println(Ki);
        Serial.print("Kd set to: ");
        Serial.println(Kd);
        break;
      case 'm':
        plotEnable = !plotEnable;
        Serial.print("plotting: ");
        Serial.println(plotEnable);
        break;
      case 't':
        turntime = incoming.substring(1).toInt();
        Serial.print("turntime set to:");
        Serial.println(turntime);

      default:
        Serial.println("nuhuh");
        break;
      }
    }
#endif
  }
}
